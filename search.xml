<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Zookeeper概念和特点初探</title>
      <link href="/posts/zookeeper-family/1/"/>
      <url>/posts/zookeeper-family/1/</url>
      
        <content type="html"><![CDATA[<p><strong>1. 什么是Zookeeper？</strong></p><p>官方文档上这么解释zookeeper，它是一个分布式协调框架，是Apache Hadoop 的一个子项目，它主要是用来解决分布式应用中经常遇到的一些数据管理问题，如：统一命名服务、状态同步服务、集群管理、分布式应用配置项的管理等。</p><p><strong>2. Zookeeper 核心概念</strong></p><p>Zookeeper 是一个用于存储少量数据的基于内存的数据库，主要有如下两个核心的概念：文件系统数据结构+监听通知机制。</p><p><strong>2.1、 文件系统数据结构</strong></p><p>Zookeeper维护一个类似文件系统的数据结构，每个子目录项都被称作为 **znode(目录节点)**，和文件系统类似，我们能够自由的增加、删除znode，在一个znode下增加、删除子znode。</p><span id="more"></span><p>有四种类型的znode：</p><p>a）PERSISTENT-持久化目录节点<font color="red">（一旦创建，永久保存）</font></p><p>客户端与zookeeper断开连接后，该节点依旧存在，只要不手动删除该节点，他将永远存在</p><p>b）PERSISTENT_SEQUENTIAL-持久化顺序编号目录节点<font color="red">（持久化节点基础上，自带顺序）</font></p><p>客户端与zookeeper断开连接后，该节点依旧存在，只是Zookeeper给该节点名称进行顺序编号</p><p>c）EPHEMERAL-临时目录节点<font color="red">（session超时，会被服务器删除）</font></p><p>客户端与zookeeper断开连接后，该节点被删除</p><p>d）EPHEMERAL_SEQUENTIAL-临时顺序编号目录节点<font color="red">（临时节点基础上，自带顺序）</font></p><p>客户端与zookeeper断开连接后，该节点被删除，只是Zookeeper给该节点名称进行顺序编号</p><p>e）Container 节点（3.5.3 版本新增，如果Container节点下面没有子节点，则Container节点在未来会被Zookeeper自动清除,定时任务默认60s 检查一次） <font color="red">（没有子节点时，会被服务器删除）</font></p><p>f）TTL 节点( 默认禁用，只能通过系统配置 <em>zookeeper.extendedTypesEnabled=true</em> 开启，不稳定)</p><p><font color="red">（过了TTL指定的时间时，被服务器删除）</font></p><p><strong>2.2、监听通知机制</strong></p><p>客户端注册监听它关心的任意节点，或者目录节点及递归子目录节点 </p><p>a）如果注册的是对某个节点的监听，则当这个节点被删除，或者被修改时，对应的客户端将被通知</p><p>b）如果注册的是对某个目录的监听，则当这个目录有子节点被创建，或者有子节点被删除，对应的客户端将被通知</p><p>c）如果注册的是对某个目录的递归子节点进行监听，则当这个目录下面的任意子节点有目录结构的变化（有子节点被创建，或被删除）或者根节点有数据变化时，对应的客户端将被通知。</p><p>注意：所有的通知都是一次性的，及无论是对节点还是对目录进行的监听，一旦触发，对应的监听即被移除。递归子节点，监听是对所有子节点的，所以，每个子节点下面的事件同样只会被触发一次。</p><p><strong>2.3、Zookeeper 经典的应用场景</strong> </p><p>a）分布式配置中心</p><p>b）分布式注册中心</p><p>c）分布式锁</p><p>d）分布式队列</p><p>e）集群选举</p><p>f）分布式屏障</p><p>g）发布/订阅</p><p><strong>3. Zookeeper 实战</strong></p><p><strong>3.1. zookeeper安装</strong></p><p><strong>Step1：</strong>配置JAVA环境，检验环境：</p><pre class=" language-java"><code class="language-java">java <span class="token operator">-</span>version</code></pre><p><strong>Step2: 下载解压 zookeeper</strong></p><pre class=" language-java"><code class="language-java">wget https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>mirror<span class="token punctuation">.</span>bit<span class="token punctuation">.</span>edu<span class="token punctuation">.</span>cn<span class="token operator">/</span>apache<span class="token operator">/</span>zookeeper<span class="token operator">/</span>zookeeper<span class="token operator">-</span><span class="token number">3.5</span><span class="token punctuation">.</span><span class="token number">8</span><span class="token operator">/</span>apache<span class="token operator">-</span>zookeeper<span class="token operator">-</span><span class="token number">3.5</span><span class="token punctuation">.</span><span class="token number">8</span><span class="token operator">-</span>bin<span class="token punctuation">.</span>tar<span class="token punctuation">.</span>gz tar <span class="token operator">-</span>zxvf apache<span class="token operator">-</span>zookeeper<span class="token operator">-</span><span class="token number">3.5</span><span class="token punctuation">.</span><span class="token number">8</span><span class="token operator">-</span>bin<span class="token punctuation">.</span>tar<span class="token punctuation">.</span>gz cd  apache<span class="token operator">-</span>zookeeper<span class="token operator">-</span><span class="token number">3.5</span><span class="token punctuation">.</span><span class="token number">8</span><span class="token operator">-</span>bin</code></pre><p><strong>Step3: 重命名配置文件  zoo_sample.cfg</strong></p><pre class=" language-java"><code class="language-java">cp zoo_sample<span class="token punctuation">.</span>cfg  zoo<span class="token punctuation">.</span>cfg</code></pre><p><strong>Step4: 启动zookeeper</strong></p><pre class=" language-java"><code class="language-java"># 可以通过 bin<span class="token operator">/</span>zkServer<span class="token punctuation">.</span>sh  来查看都支持哪些参数  bin<span class="token operator">/</span>zkServer<span class="token punctuation">.</span>sh start conf<span class="token operator">/</span>zoo<span class="token punctuation">.</span>cfg</code></pre><p><strong>Step5: 检测是否启动成功</strong></p><pre class=" language-java"><code class="language-java">echo stat <span class="token operator">|</span> nc <span class="token number">192.168</span><span class="token punctuation">.</span><span class="token number">109.200</span> <span class="token comment" spellcheck="true">// 前提是配置文件中将 stat 四字命令设置了了白名单  </span>如： 4lw<span class="token punctuation">.</span>commands<span class="token punctuation">.</span>whitelist<span class="token operator">=</span>stat    </code></pre><p><strong>Step6: 连接服务器</strong></p><pre class=" language-java"><code class="language-java">bin<span class="token operator">/</span>zkCli<span class="token punctuation">.</span>sh <span class="token operator">-</span>server ip<span class="token operator">:</span>port </code></pre><p><strong>3.2. 使用命令行操作zookeeper</strong></p><p><strong>输入命令 help 查看zookeeper所支持的所有命令：</strong></p><pre class=" language-java"><code class="language-java"><span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">80</span><span class="token punctuation">]</span> helpZooKeeper <span class="token operator">-</span>server host<span class="token operator">:</span>port cmd args    addauth scheme auth    close     config <span class="token punctuation">[</span><span class="token operator">-</span>c<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">-</span>w<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">-</span>s<span class="token punctuation">]</span>    connect host<span class="token operator">:</span>port    create <span class="token punctuation">[</span><span class="token operator">-</span>s<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">-</span>e<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">-</span>c<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">-</span>t ttl<span class="token punctuation">]</span> path <span class="token punctuation">[</span>data<span class="token punctuation">]</span> <span class="token punctuation">[</span>acl<span class="token punctuation">]</span>    delete <span class="token punctuation">[</span><span class="token operator">-</span>v version<span class="token punctuation">]</span> path    deleteall path    delquota <span class="token punctuation">[</span><span class="token operator">-</span>n<span class="token operator">|</span><span class="token operator">-</span>b<span class="token punctuation">]</span> path    get <span class="token punctuation">[</span><span class="token operator">-</span>s<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">-</span>w<span class="token punctuation">]</span> path    getAcl <span class="token punctuation">[</span><span class="token operator">-</span>s<span class="token punctuation">]</span> path    history     listquota path    ls <span class="token punctuation">[</span><span class="token operator">-</span>s<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">-</span>w<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">-</span>R<span class="token punctuation">]</span> path    ls2 path <span class="token punctuation">[</span>watch<span class="token punctuation">]</span>    printwatches on<span class="token operator">|</span>off    quit     reconfig <span class="token punctuation">[</span><span class="token operator">-</span>s<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">-</span>v version<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token operator">-</span>file path<span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token punctuation">[</span><span class="token operator">-</span>members serverID<span class="token operator">=</span>host<span class="token operator">:</span>port1<span class="token operator">:</span>port2<span class="token punctuation">;</span>port3<span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token punctuation">[</span><span class="token operator">-</span>add serverId<span class="token operator">=</span>host<span class="token operator">:</span>port1<span class="token operator">:</span>port2<span class="token punctuation">;</span>port3<span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">*</span> <span class="token punctuation">[</span><span class="token operator">-</span>remove serverId<span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token punctuation">]</span>    redo cmdno    removewatches path <span class="token punctuation">[</span><span class="token operator">-</span>c<span class="token operator">|</span><span class="token operator">-</span>d<span class="token operator">|</span><span class="token operator">-</span>a<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">-</span>l<span class="token punctuation">]</span>    rmr path    set <span class="token punctuation">[</span><span class="token operator">-</span>s<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">-</span>v version<span class="token punctuation">]</span> path data    setAcl <span class="token punctuation">[</span><span class="token operator">-</span>s<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">-</span>v version<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">-</span>R<span class="token punctuation">]</span> path acl    setquota <span class="token operator">-</span>n<span class="token operator">|</span><span class="token operator">-</span>b val path    stat <span class="token punctuation">[</span><span class="token operator">-</span>w<span class="token punctuation">]</span> path    sync path</code></pre><p>1、创建zookeeper 节点命令</p><pre class=" language-java"><code class="language-java">create <span class="token punctuation">[</span><span class="token operator">-</span>s<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">-</span>e<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">-</span>c<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">-</span>t ttl<span class="token punctuation">]</span> path <span class="token punctuation">[</span>data<span class="token punctuation">]</span> <span class="token punctuation">[</span>acl<span class="token punctuation">]</span></code></pre><p>中括号为可选项，没有则默认创建持久化节点</p><p>-s: 顺序节点</p><p>-e: 临时节点</p><p>-c: 容器节点</p><p>-t:  可以给节点添加过期时间，默认禁用，需要通过系统参数启用</p><p>（-D<em>zookeeper.extendedTypesEnabled=true</em>,  <em>znode.container.checkIntervalMs</em> : (Java system property only) <strong>New in 3.5.1:</strong> The time interval in milliseconds for each check of candidate container and ttl nodes. Default is “60000”.)</p><p>创建节点：</p><pre class=" language-java"><code class="language-java"><span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">2</span><span class="token punctuation">]</span> ls <span class="token operator">/</span><span class="token punctuation">[</span>zookeeper<span class="token punctuation">]</span><span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">3</span><span class="token punctuation">]</span> create <span class="token operator">/</span>test<span class="token operator">-</span>node some<span class="token operator">-</span>dataCreated <span class="token operator">/</span>test<span class="token operator">-</span>node</code></pre><p>查看节点：</p><pre class=" language-java"><code class="language-java"><span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">4</span><span class="token punctuation">]</span> get <span class="token operator">/</span>test<span class="token operator">-</span>nodesome<span class="token operator">-</span>data</code></pre><p>修改节点数据：</p><pre class=" language-java"><code class="language-java"><span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">5</span><span class="token punctuation">]</span> set <span class="token operator">/</span>test<span class="token operator">-</span>node some<span class="token operator">-</span>data<span class="token operator">-</span>changed<span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">6</span><span class="token punctuation">]</span> get <span class="token operator">/</span>test<span class="token operator">-</span>nodesome<span class="token operator">-</span>data<span class="token operator">-</span>changed</code></pre><p>查看节点状态信息：</p><pre class=" language-java"><code class="language-java"><span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">7</span><span class="token punctuation">]</span> stat <span class="token operator">/</span>test<span class="token operator">-</span>nodecZxid <span class="token operator">=</span> <span class="token number">0x2</span> #创建znode的事务ID（Zxid的值）ctime <span class="token operator">=</span> Mon Jun <span class="token number">06</span> <span class="token number">19</span><span class="token operator">:</span><span class="token number">36</span><span class="token operator">:</span><span class="token number">15</span> CST <span class="token number">2022</span> #znode创建时间mZxid <span class="token operator">=</span> <span class="token number">0x3</span> #最后修改znode的事务IDmtime <span class="token operator">=</span> Mon Jun <span class="token number">06</span> <span class="token number">19</span><span class="token operator">:</span><span class="token number">36</span><span class="token operator">:</span><span class="token number">44</span> CST <span class="token number">2022</span> #znode最近修改时间pZxid <span class="token operator">=</span> <span class="token number">0x2</span> #最后添加或删除子节点的事务ID（子节点列表发生变化才会发生改变）cversion <span class="token operator">=</span> <span class="token number">0</span> #znode的子节点结果集版本（一个节点的子节点增加、删除都会影响这个版本）dataVersion <span class="token operator">=</span> <span class="token number">1</span> #znode的当前数据版本，可以实现乐观锁 set <span class="token operator">-</span>v <span class="token punctuation">[</span>版本号<span class="token punctuation">]</span>aclVersion <span class="token operator">=</span> <span class="token number">0</span> #表示对此znode的acl版本ephemeralOwner <span class="token operator">=</span> <span class="token number">0x0</span> #是临时znode时，表示znode所有者的 session ID。不是临时znode该字段设置为零dataLength <span class="token operator">=</span> <span class="token number">17</span> #znode数据字段的长度，some<span class="token operator">-</span>data<span class="token operator">-</span>changed 的长度<span class="token number">17</span>numChildren <span class="token operator">=</span> <span class="token number">0</span> #znode的子znode的数量</code></pre><p>查看节点状态信息同时查看数据</p><pre class=" language-java"><code class="language-java"><span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">8</span><span class="token punctuation">]</span> get <span class="token operator">-</span>s <span class="token operator">/</span>test<span class="token operator">-</span>nodesome<span class="token operator">-</span>data<span class="token operator">-</span>changed #多返回原始数据cZxid <span class="token operator">=</span> <span class="token number">0x2</span>ctime <span class="token operator">=</span> Mon Jun <span class="token number">06</span> <span class="token number">19</span><span class="token operator">:</span><span class="token number">36</span><span class="token operator">:</span><span class="token number">15</span> CST <span class="token number">2022</span>mZxid <span class="token operator">=</span> <span class="token number">0x3</span>mtime <span class="token operator">=</span> Mon Jun <span class="token number">06</span> <span class="token number">19</span><span class="token operator">:</span><span class="token number">36</span><span class="token operator">:</span><span class="token number">44</span> CST <span class="token number">2022</span>pZxid <span class="token operator">=</span> <span class="token number">0x2</span>cversion <span class="token operator">=</span> <span class="token number">0</span>dataVersion <span class="token operator">=</span> <span class="token number">1</span>aclVersion <span class="token operator">=</span> <span class="token number">0</span>ephemeralOwner <span class="token operator">=</span> <span class="token number">0x0</span>dataLength <span class="token operator">=</span> <span class="token number">17</span>numChildren <span class="token operator">=</span> <span class="token number">0</span></code></pre><p>根据状态数据中的版本号有并发修改数据实现乐观锁的功能</p><pre class=" language-java"><code class="language-java"><span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">9</span><span class="token punctuation">]</span> set <span class="token operator">-</span>v <span class="token number">1</span> <span class="token operator">/</span>test<span class="token operator">-</span>node changed<span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">10</span><span class="token punctuation">]</span> set <span class="token operator">-</span>v <span class="token number">1</span> <span class="token operator">/</span>test<span class="token operator">-</span>node changedversion No is not valid <span class="token operator">:</span> <span class="token operator">/</span>test<span class="token operator">-</span>node</code></pre><p>创建子节点， 这里要注意，zookeeper是以节点组织数据的，没有相对路径这么一说，所以，所有的节点一定是以 / 开头</p><pre class=" language-java"><code class="language-java"><span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">12</span><span class="token punctuation">]</span> create <span class="token operator">/</span>test<span class="token operator">-</span>node<span class="token operator">/</span>test<span class="token operator">-</span>sub<span class="token operator">-</span>nodeCreated <span class="token operator">/</span>test<span class="token operator">-</span>node<span class="token operator">/</span>test<span class="token operator">-</span>sub<span class="token operator">-</span>node</code></pre><p>查看子节点信息，比如根节点下面的所有子节点， 加一个大写 R  可以查看递归子节点列表</p><p>查看 /test-node 下面所有的子节点 </p><pre class=" language-java"><code class="language-java"><span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">13</span><span class="token punctuation">]</span> ls <span class="token operator">/</span>test<span class="token operator">-</span>node<span class="token punctuation">[</span>test<span class="token operator">-</span>sub<span class="token operator">-</span>node<span class="token punctuation">]</span><span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">14</span><span class="token punctuation">]</span> ls <span class="token operator">-</span>R <span class="token operator">/</span>test<span class="token operator">-</span>node<span class="token operator">/</span>test<span class="token operator">-</span>node<span class="token operator">/</span>test<span class="token operator">-</span>node<span class="token operator">/</span>test<span class="token operator">-</span>sub<span class="token operator">-</span>node</code></pre><p>创建临时节点</p><pre class=" language-java"><code class="language-java"><span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">15</span><span class="token punctuation">]</span> create <span class="token operator">-</span>e <span class="token operator">/</span>ephemeral dataCreated <span class="token operator">/</span>ephemeral</code></pre><p>create 后跟一个 -e 创建临时节点 ， 临时节点不能创建子节点</p><pre class=" language-java"><code class="language-java"><span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">16</span><span class="token punctuation">]</span> create <span class="token operator">/</span>ephemeral<span class="token operator">/</span>nodeEphemerals cannot have children<span class="token operator">:</span> <span class="token operator">/</span>ephemeral<span class="token operator">/</span>node</code></pre><p>创建序号节点，加参数 -s</p><pre class=" language-java"><code class="language-java"><span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">17</span><span class="token punctuation">]</span> create <span class="token operator">/</span>seq<span class="token operator">-</span>parent dataCreated <span class="token operator">/</span>seq<span class="token operator">-</span>parent<span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">18</span><span class="token punctuation">]</span><span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">18</span><span class="token punctuation">]</span> create <span class="token operator">-</span>s <span class="token operator">/</span>seq<span class="token operator">-</span>parent<span class="token operator">/</span> dataCreated <span class="token operator">/</span>seq<span class="token operator">-</span>parent<span class="token operator">/</span><span class="token number">0000000000</span><span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">19</span><span class="token punctuation">]</span><span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">19</span><span class="token punctuation">]</span> create <span class="token operator">-</span>s <span class="token operator">/</span>seq<span class="token operator">-</span>parent<span class="token operator">/</span> data2Created <span class="token operator">/</span>seq<span class="token operator">-</span>parent<span class="token operator">/</span><span class="token number">0000000001</span><span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">20</span><span class="token punctuation">]</span> ls <span class="token operator">-</span>R <span class="token operator">/</span>seq<span class="token operator">-</span>parent<span class="token operator">/</span>seq<span class="token operator">-</span>parent<span class="token operator">/</span>seq<span class="token operator">-</span>parent<span class="token operator">/</span><span class="token number">0000000000</span><span class="token operator">/</span>seq<span class="token operator">-</span>parent<span class="token operator">/</span><span class="token number">0000000001</span></code></pre><p>创建临时顺序节点,其它增删查改和其他节点无异</p><pre class=" language-java"><code class="language-java">create <span class="token operator">-</span>s <span class="token operator">-</span>e  <span class="token operator">/</span>ephemeral<span class="token operator">-</span>node<span class="token operator">/</span>前缀<span class="token operator">-</span><span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">23</span><span class="token punctuation">]</span> create <span class="token operator">-</span>s <span class="token operator">-</span>e <span class="token operator">/</span>ephemeral<span class="token operator">-</span>node<span class="token operator">/</span>gaxCreated <span class="token operator">/</span>ephemeral<span class="token operator">-</span>node<span class="token operator">/</span>gax0000000000</code></pre><p>创建容器节点 </p><pre class=" language-java"><code class="language-java"><span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">24</span><span class="token punctuation">]</span> create <span class="token operator">-</span>c <span class="token operator">/</span>containerCreated <span class="token operator">/</span>container<span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">25</span><span class="token punctuation">]</span><span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">25</span><span class="token punctuation">]</span> ls <span class="token operator">/</span>container<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">26</span><span class="token punctuation">]</span> create <span class="token operator">/</span>container<span class="token operator">/</span>tCreated <span class="token operator">/</span>container<span class="token operator">/</span>t<span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">27</span><span class="token punctuation">]</span><span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">27</span><span class="token punctuation">]</span> delete <span class="token operator">/</span>container<span class="token operator">/</span>t<span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">28</span><span class="token punctuation">]</span><span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">28</span><span class="token punctuation">]</span> ls <span class="token operator">/</span><span class="token punctuation">[</span>container<span class="token punctuation">,</span> ephemeral<span class="token punctuation">,</span> ephemeral<span class="token operator">-</span>node<span class="token punctuation">,</span> seq<span class="token operator">-</span>parent<span class="token punctuation">,</span> test<span class="token operator">-</span>node<span class="token punctuation">,</span> zookeeper<span class="token punctuation">]</span><span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">29</span><span class="token punctuation">]</span> ls <span class="token operator">/</span><span class="token punctuation">[</span>ephemeral<span class="token punctuation">,</span> ephemeral<span class="token operator">-</span>node<span class="token punctuation">,</span> seq<span class="token operator">-</span>parent<span class="token punctuation">,</span> test<span class="token operator">-</span>node<span class="token punctuation">,</span> zookeeper<span class="token punctuation">]</span></code></pre><p>容器节点主要用来容纳子节点，如果没有给其创建子节点，容器节点表现和持久化节点一样，如果给容器节点创建了子节点，后续又把子节点清空，容器节点也会被zookeeper删除。</p><p>2、事件监听机制：</p><p>针对节点的监听：一但事件触发，对应的注册立刻被移除，所以事件监听是一次性的</p><pre class=" language-java"><code class="language-java"><span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">30</span><span class="token punctuation">]</span> get <span class="token operator">-</span>w <span class="token operator">/</span>test<span class="token operator">-</span>node #注册监听的同时获取数据changed<span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">31</span><span class="token punctuation">]</span><span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">31</span><span class="token punctuation">]</span> stat <span class="token operator">-</span>w <span class="token operator">/</span>test<span class="token operator">-</span>node #对节点进行监听，且获取元数据信息cZxid <span class="token operator">=</span> <span class="token number">0x2</span>ctime <span class="token operator">=</span> Mon Jun <span class="token number">06</span> <span class="token number">19</span><span class="token operator">:</span><span class="token number">36</span><span class="token operator">:</span><span class="token number">15</span> CST <span class="token number">2022</span>mZxid <span class="token operator">=</span> <span class="token number">0x4</span>mtime <span class="token operator">=</span> Mon Jun <span class="token number">06</span> <span class="token number">19</span><span class="token operator">:</span><span class="token number">43</span><span class="token operator">:</span><span class="token number">39</span> CST <span class="token number">2022</span>pZxid <span class="token operator">=</span> <span class="token number">0x6</span>cversion <span class="token operator">=</span> <span class="token number">1</span>dataVersion <span class="token operator">=</span> <span class="token number">2</span>aclVersion <span class="token operator">=</span> <span class="token number">0</span>ephemeralOwner <span class="token operator">=</span> <span class="token number">0x0</span>dataLength <span class="token operator">=</span> <span class="token number">7</span>numChildren <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">32</span><span class="token punctuation">]</span> set <span class="token operator">/</span>test<span class="token operator">-</span>node abcWATCHER<span class="token operator">:</span><span class="token operator">:</span>WatchedEvent state<span class="token operator">:</span>SyncConnected type<span class="token operator">:</span>NodeDataChanged path<span class="token operator">:</span><span class="token operator">/</span>test<span class="token operator">-</span>node<span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">33</span><span class="token punctuation">]</span> set <span class="token operator">/</span>test<span class="token operator">-</span>node abcd<span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">34</span><span class="token punctuation">]</span></code></pre><p>针对目录的监听，目录的变化会触发事件，且一旦触发，对应的监听也会被移除，后续对节点的创建没有触发监听事件</p><pre class=" language-java"><code class="language-java"><span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">35</span><span class="token punctuation">]</span> ls <span class="token operator">/</span>test<span class="token operator">-</span>node<span class="token punctuation">[</span>test<span class="token operator">-</span>sub<span class="token operator">-</span>node<span class="token punctuation">]</span><span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">36</span><span class="token punctuation">]</span><span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">36</span><span class="token punctuation">]</span> get <span class="token operator">-</span>w <span class="token operator">/</span>test<span class="token operator">-</span>node #监听节点abcd<span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">37</span><span class="token punctuation">]</span><span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">37</span><span class="token punctuation">]</span> delete <span class="token operator">/</span>test<span class="token operator">-</span>node<span class="token operator">/</span>test<span class="token operator">-</span>sub<span class="token operator">-</span>node<span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">38</span><span class="token punctuation">]</span><span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">38</span><span class="token punctuation">]</span> ls <span class="token operator">/</span>test<span class="token operator">-</span>node<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">39</span><span class="token punctuation">]</span><span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">39</span><span class="token punctuation">]</span> create <span class="token operator">/</span>test<span class="token operator">-</span>node<span class="token operator">/</span>sub0Created <span class="token operator">/</span>test<span class="token operator">-</span>node<span class="token operator">/</span>sub0<span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">40</span><span class="token punctuation">]</span> ls <span class="token operator">-</span>w <span class="token operator">/</span>test<span class="token operator">-</span>node #监听目录<span class="token punctuation">[</span>sub0<span class="token punctuation">]</span><span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">41</span><span class="token punctuation">]</span><span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">41</span><span class="token punctuation">]</span> delete <span class="token operator">/</span>test<span class="token operator">-</span>node<span class="token operator">/</span>sub0WATCHER<span class="token operator">:</span><span class="token operator">:</span>WatchedEvent state<span class="token operator">:</span>SyncConnected type<span class="token operator">:</span>NodeChildrenChanged path<span class="token operator">:</span><span class="token operator">/</span>test<span class="token operator">-</span>node<span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">42</span><span class="token punctuation">]</span><span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">42</span><span class="token punctuation">]</span> create <span class="token operator">/</span>test<span class="token operator">-</span>node<span class="token operator">/</span>sub1Created <span class="token operator">/</span>test<span class="token operator">-</span>node<span class="token operator">/</span>sub1<span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">43</span><span class="token punctuation">]</span></code></pre><p>针对递归子目录的监听</p><pre class=" language-java"><code class="language-java"><span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">43</span><span class="token punctuation">]</span> create <span class="token operator">/</span>test<span class="token operator">-</span>node<span class="token operator">/</span>sub2Created <span class="token operator">/</span>test<span class="token operator">-</span>node<span class="token operator">/</span>sub2<span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">44</span><span class="token punctuation">]</span><span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">44</span><span class="token punctuation">]</span> ls <span class="token operator">-</span>w <span class="token operator">/</span>test<span class="token operator">-</span>node<span class="token punctuation">[</span>sub1<span class="token punctuation">,</span> sub2<span class="token punctuation">]</span><span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">45</span><span class="token punctuation">]</span><span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">45</span><span class="token punctuation">]</span> create <span class="token operator">/</span>test<span class="token operator">-</span>node<span class="token operator">/</span>sub3WATCHER<span class="token operator">:</span><span class="token operator">:</span>WatchedEvent state<span class="token operator">:</span>SyncConnected type<span class="token operator">:</span>NodeChildrenChanged path<span class="token operator">:</span><span class="token operator">/</span>test<span class="token operator">-</span>nodeCreated <span class="token operator">/</span>test<span class="token operator">-</span>node<span class="token operator">/</span>sub3<span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">46</span><span class="token punctuation">]</span><span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">46</span><span class="token punctuation">]</span> create <span class="token operator">/</span>test<span class="token operator">-</span>node<span class="token operator">/</span>sub4Created <span class="token operator">/</span>test<span class="token operator">-</span>node<span class="token operator">/</span>sub4<span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">47</span><span class="token punctuation">]</span><span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">47</span><span class="token punctuation">]</span> ls <span class="token operator">-</span>w <span class="token operator">-</span>R <span class="token operator">/</span>test<span class="token operator">-</span>node<span class="token operator">/</span>test<span class="token operator">-</span>node<span class="token operator">/</span>test<span class="token operator">-</span>node<span class="token operator">/</span>sub1<span class="token operator">/</span>test<span class="token operator">-</span>node<span class="token operator">/</span>sub2<span class="token operator">/</span>test<span class="token operator">-</span>node<span class="token operator">/</span>sub3<span class="token operator">/</span>test<span class="token operator">-</span>node<span class="token operator">/</span>sub4<span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">48</span><span class="token punctuation">]</span><span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">48</span><span class="token punctuation">]</span> create <span class="token operator">/</span>test<span class="token operator">-</span>node<span class="token operator">/</span>subsub1   sub2   sub3   sub4<span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">48</span><span class="token punctuation">]</span> create <span class="token operator">/</span>test<span class="token operator">-</span>node<span class="token operator">/</span>sub1<span class="token operator">/</span>sub0WATCHER<span class="token operator">:</span><span class="token operator">:</span>WatchedEvent state<span class="token operator">:</span>SyncConnected type<span class="token operator">:</span>NodeChildrenChanged path<span class="token operator">:</span><span class="token operator">/</span>test<span class="token operator">-</span>node<span class="token operator">/</span>sub1Created <span class="token operator">/</span>test<span class="token operator">-</span>node<span class="token operator">/</span>sub1<span class="token operator">/</span>sub0<span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">49</span><span class="token punctuation">]</span><span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">49</span><span class="token punctuation">]</span> create <span class="token operator">/</span>test<span class="token operator">-</span>node<span class="token operator">/</span>sub1<span class="token operator">/</span>sub7Created <span class="token operator">/</span>test<span class="token operator">-</span>node<span class="token operator">/</span>sub1<span class="token operator">/</span>sub7<span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">50</span><span class="token punctuation">]</span><span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">50</span><span class="token punctuation">]</span> create <span class="token operator">/</span>test<span class="token operator">-</span>node<span class="token operator">/</span>subsub1   sub2   sub3   sub4<span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">50</span><span class="token punctuation">]</span> create <span class="token operator">/</span>test<span class="token operator">-</span>node<span class="token operator">/</span>sub2<span class="token operator">/</span>sub8WATCHER<span class="token operator">:</span><span class="token operator">:</span>WatchedEvent state<span class="token operator">:</span>SyncConnected type<span class="token operator">:</span>NodeChildrenChanged path<span class="token operator">:</span><span class="token operator">/</span>test<span class="token operator">-</span>node<span class="token operator">/</span>sub2Created <span class="token operator">/</span>test<span class="token operator">-</span>node<span class="token operator">/</span>sub2<span class="token operator">/</span>sub8<span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">51</span><span class="token punctuation">]</span><span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">51</span><span class="token punctuation">]</span> create <span class="token operator">/</span>test<span class="token operator">-</span>node<span class="token operator">/</span>sub3<span class="token operator">/</span>sub9WATCHER<span class="token operator">:</span><span class="token operator">:</span>WatchedEvent state<span class="token operator">:</span>SyncConnected type<span class="token operator">:</span>NodeChildrenChanged path<span class="token operator">:</span><span class="token operator">/</span>test<span class="token operator">-</span>node<span class="token operator">/</span>sub3Created <span class="token operator">/</span>test<span class="token operator">-</span>node<span class="token operator">/</span>sub3<span class="token operator">/</span>sub9<span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">52</span><span class="token punctuation">]</span><span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">52</span><span class="token punctuation">]</span> delete <span class="token operator">/</span>test<span class="token operator">-</span>node<span class="token operator">/</span>sub4WATCHER<span class="token operator">:</span><span class="token operator">:</span>WatchedEvent state<span class="token operator">:</span>SyncConnected type<span class="token operator">:</span>NodeDeleted path<span class="token operator">:</span><span class="token operator">/</span>test<span class="token operator">-</span>node<span class="token operator">/</span>sub4WATCHER<span class="token operator">:</span><span class="token operator">:</span>WatchedEvent state<span class="token operator">:</span>SyncConnected type<span class="token operator">:</span>NodeChildrenChanged path<span class="token operator">:</span><span class="token operator">/</span>test<span class="token operator">-</span>node<span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">53</span><span class="token punctuation">]</span><span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">53</span><span class="token punctuation">]</span> ls <span class="token operator">/</span>test<span class="token operator">-</span>node<span class="token punctuation">[</span>sub1<span class="token punctuation">,</span> sub2<span class="token punctuation">,</span> sub3<span class="token punctuation">]</span><span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">54</span><span class="token punctuation">]</span><span class="token punctuation">[</span>zk<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token function">2181</span><span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">54</span><span class="token punctuation">]</span> delete <span class="token operator">/</span>test<span class="token operator">-</span>node<span class="token operator">/</span>sub3Node not empty<span class="token operator">:</span> <span class="token operator">/</span>test<span class="token operator">-</span>node<span class="token operator">/</span>sub3</code></pre><pre class=" language-java"><code class="language-java">Zookeeper事件类型：None<span class="token operator">:</span> 连接建立事件NodeCreated： 节点创建NodeDeleted： 节点删除NodeDataChanged：节点数据变化NodeChildrenChanged：子节点列表变化DataWatchRemoved：节点监听被移除ChildWatchRemoved：子节点监听被移除</code></pre>]]></content>
      
      
      
        <tags>
            
            <tag> zookeeper </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Redis数据结构深入学习</title>
      <link href="/posts/redis-family/2/"/>
      <url>/posts/redis-family/2/</url>
      
        <content type="html"><![CDATA[<p><strong>List常用API</strong></p><pre class=" language-java"><code class="language-java"><span class="token operator">/</span><span class="token operator">></span> help <span class="token annotation punctuation">@list</span>LPUSH key element <span class="token punctuation">[</span>element <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>RPOP keyRPUSH key element <span class="token punctuation">[</span>element <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>LPOP keyBLPOP key <span class="token punctuation">[</span>key <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span> timeoutBRPOP key <span class="token punctuation">[</span>key <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span> timeoutBRPOPLPUSH source destination timeoutRPOPLPUSH  source destinationLINDEX key indexLLEN keyLINSERT key BEFORE<span class="token operator">|</span>AFTER pivot elementLRANGE key start stopLREM key count elementLSET key index elementLTRIM key start stop </code></pre> <span id="more"></span> <p>List是一个有序(按加入的时序排序)的数据结构，Redis采用<font color="red">quicklist（双端链表） 和 ziplist</font> 作为List的底层实现。</p><p>可以通过设置每个ziplist的最大容量，quicklist的数据压缩范围，提升数据存取效率</p><pre><code>list-max-ziplist-size  -2        //  单个ziplist节点最大能存储  8kb  ,超过则进行分裂,将数据存储在新的ziplist节点中list-compress-depth  1        //  0 代表所有节点，都不进行压缩，1， 代表从头节点往后走一个，尾节点往前走一个不用压缩，其他的全部压缩，2，3，4 ... 以此类推</code></pre><p><a href="https://www.processon.com/view/link/6295f9985653bb788c8546fe">Redis - quicklist 数据结构：</a></p><p><a href="https://www.processon.com/view/link/6295f9b27d9c085adb7a7561">Redis - ziplist 数据结构：</a></p><p><strong>Hash常用API</strong></p><pre class=" language-java"><code class="language-java"><span class="token operator">/</span><span class="token operator">></span> help  <span class="token annotation punctuation">@hash</span> HSET key field value <span class="token punctuation">[</span>field value <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>HGET key fieldHMGET key field <span class="token punctuation">[</span>field <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>HKEYS keyHGETALL keyHVALS keyHEXISTS key fieldHDEL key field <span class="token punctuation">[</span>field <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>HINCRBY key field incrementHINCRBYFLOAT key field incrementHLEN keyHSCAN key cursor <span class="token punctuation">[</span>MATCH pattern<span class="token punctuation">]</span> <span class="token punctuation">[</span>COUNT count<span class="token punctuation">]</span>HSETNX key field valueHSTRLEN key field </code></pre><p>Hash 数据结构底层实现为一个<font color="red">字典( dict )</font>，也是RedisBb用来存储K-V的数据结构,当数据量比较小，或者单个元素比较小时，底层用<font color="red">ziplist存储</font>，数据大小和元素数量阈值可以通过如下参数设置。</p><pre class=" language-java"><code class="language-java">hash<span class="token operator">-</span>max<span class="token operator">-</span>ziplist<span class="token operator">-</span>entries  <span class="token number">512</span>    <span class="token comment" spellcheck="true">//  ziplist 元素个数超过 512 ，将改为hashtable编码 </span>hash<span class="token operator">-</span>max<span class="token operator">-</span>ziplist<span class="token operator">-</span>value    <span class="token number">64</span>      <span class="token comment" spellcheck="true">//  单个元素大小超过 64 byte时，将改为hashtable编码</span></code></pre><p><a href="https://www.processon.com/view/link/6295f973e401fd2eed19c806">Redis - hash 数据结构：</a></p><p><strong>Set常用API</strong></p><pre class=" language-java"><code class="language-java"><span class="token operator">/</span><span class="token operator">></span> help  <span class="token annotation punctuation">@set</span>SADD key member <span class="token punctuation">[</span>member <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>              SCARD key                                                 SISMEMBER key memberSPOP key <span class="token punctuation">[</span>count<span class="token punctuation">]</span>SDIFF key <span class="token punctuation">[</span>key <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>SINTER key <span class="token punctuation">[</span>key <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>SUNION key <span class="token punctuation">[</span>key <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>SMEMBERS keySRANDMEMBER key <span class="token punctuation">[</span>count<span class="token punctuation">]</span>SREM key member <span class="token punctuation">[</span>member <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>SMOVE source destination memberSUNIONSTORE destination key <span class="token punctuation">[</span>key <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>SDIFFSTORE destination key <span class="token punctuation">[</span>key <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>SINTERSTORE destination key <span class="token punctuation">[</span>key <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>SSCAN key cursor <span class="token punctuation">[</span>MATCH pattern<span class="token punctuation">]</span> <span class="token punctuation">[</span>COUNT count<span class="token punctuation">]</span> </code></pre><p>Set 为无序的，自动去重的集合数据类型，Set 数据结构底层实现为一个<font color="red">value 为 null 的 字典( dict )</font>，当数据可以用整形表示时，Set集合将被编码为<font color="red">intset</font>数据结构。两个条件任意满足时<br>Set将用hashtable存储数据。1， 元素个数大于 set-max-intset-entries , 2 ， 元素无法用整形表示 </p><pre class=" language-java"><code class="language-java">set<span class="token operator">-</span>max<span class="token operator">-</span>intset<span class="token operator">-</span>entries <span class="token number">512</span>       <span class="token comment" spellcheck="true">// intset 能存储的最大元素个数，超过则用hashtable编码</span></code></pre><p><a href="https://www.processon.com/view/link/6295f95b1e0853255ddd2439">Redis - set 数据结构：</a></p><p><strong>ZSet常用API</strong></p><pre class=" language-java"><code class="language-java"><span class="token operator">/</span><span class="token operator">></span> help  <span class="token annotation punctuation">@sorted_set</span>ZADD key <span class="token punctuation">[</span>NX<span class="token operator">|</span>XX<span class="token punctuation">]</span> <span class="token punctuation">[</span>CH<span class="token punctuation">]</span> <span class="token punctuation">[</span>INCR<span class="token punctuation">]</span> score member <span class="token punctuation">[</span>score member <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>ZCARD keyZCOUNT key min maxZINCRBY key increment memberZRANGE key start stop <span class="token punctuation">[</span>WITHSCORES<span class="token punctuation">]</span>ZRANGEBYSCORE key min max <span class="token punctuation">[</span>WITHSCORES<span class="token punctuation">]</span> <span class="token punctuation">[</span>LIMIT offset count<span class="token punctuation">]</span>ZRANK key memberZREM key member <span class="token punctuation">[</span>member <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>ZREMRANGEBYRANK key start stopZREMRANGEBYSCORE key min maxZREVRANGE key start stop <span class="token punctuation">[</span>WITHSCORES<span class="token punctuation">]</span>ZREVRANGEBYSCORE key max min <span class="token punctuation">[</span>WITHSCORES<span class="token punctuation">]</span> <span class="token punctuation">[</span>LIMIT offset count<span class="token punctuation">]</span>ZREVRANK key memberZSCAN key cursor <span class="token punctuation">[</span>MATCH pattern<span class="token punctuation">]</span> <span class="token punctuation">[</span>COUNT count<span class="token punctuation">]</span>ZSCORE key member</code></pre><p>ZSet  为有序的，自动去重的集合数据类型，ZSet 数据结构底层实现为 <font color="red">字典(dict) + 跳表(skiplist) </font>，当数据比较少时，用ziplist编码结构存储。 </p><pre class=" language-java"><code class="language-java">zset<span class="token operator">-</span>max<span class="token operator">-</span>ziplist<span class="token operator">-</span>entries  <span class="token number">128</span>    <span class="token comment" spellcheck="true">// 元素个数超过128 ，将用skiplist编码</span>zset<span class="token operator">-</span>max<span class="token operator">-</span>ziplist<span class="token operator">-</span>value     <span class="token number">64</span>     <span class="token comment" spellcheck="true">//  单个元素大小超过 64 byte, 将用 skiplist编码</span></code></pre><p><a href="https://www.processon.com/view/link/6295f943e0b34d481b3cc017">Redis - zset 数据结构：</a></p><p><a href="https://www.processon.com/view/link/6295f8fb1e0853255ddd234c">Redis - skiplist 数据结构：</a></p><p>补充：<a href="https://www.processon.com/view/link/628e1fdd0791291ba20185c4">Redis - string 数据结构：</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Redis基础学习和string数据结构初探</title>
      <link href="/posts/redis-family/1/"/>
      <url>/posts/redis-family/1/</url>
      
        <content type="html"><![CDATA[<h4 id="Redis基本特性"><a href="#Redis基本特性" class="headerlink" title="Redis基本特性"></a><code>Redis</code>基本特性</h4><p>a) 非关系型的<font color="red">键值对</font>数据库，可以根据键以O(1) 的时间复杂度取出或插入关联值</p><p>b) <code>Redis</code> 的数据是存在<font color="red">内存</font>中的</p><p>c) 键值对中键的类型可以是字符串，整型，浮点型等，且键是唯一的</p><p>d) 键值对中的值类型可以是string，hash，list，set，sorted set 等</p><p>e) <code>Redis</code> 内置了复制，磁盘持久化，<code>LUA</code>脚本，事务，<font color="orange">SSL,  ACLs，客户端缓存，客户端代理等功能（6.0新特性）</font></p><p>f) 通过<code>Redis</code> 哨兵和<code>Redis Cluster</code> 模式提供高可用性</p> <span id="more"></span> <h4 id="Redis应用场景"><a href="#Redis应用场景" class="headerlink" title="Redis应用场景"></a><code>Redis</code>应用场景</h4><p>a) 计数器<br>可以对 String 进行自增自减运算，从而实现计数器功能。<code>Redis</code> 这种内存型数据库的读写性能非常高，很适合存储频繁读写的计数量。 </p><p>b) 分布式ID生成<br>利用自增特性，一次请求一个大一点的步长如 <code>incr 2000</code> ,缓存在本地使用，用完再请求。</p><p>c) 海量数据统计<br>位图（bitmap）:存储是否参过某次活动，是否已读谋篇文章，用户是否为会员， 日活统计。</p><p>d) 会话缓存<br>可以使用 <code>Redis</code> 来统一存储多台应用服务器的会话信息。当应用服务器不再存储用户的会话信息，也就不再具有状态，一个用户可以请求任意一个应用服务器，从而更容易实现高可用性以及可伸缩性。</p><p>e) 分布式队列/阻塞队列<br>List 是一个双向链表，可以通过 <code>lpush/rpush</code> 和 <code>rpop/lpop</code> 写入和读取消息。可以通过使用<code>brpop/blpop</code> 来实现阻塞队列。</p><p>f) 分布式锁实现<br>在分布式场景下，无法使用基于进程的锁来对多个节点上的进程进行同步。可以使用 <code>Redis</code> 自带的 <code>SETNX</code> 命令实现分布式锁。</p><p>g) 热点数据存储<br>最新评论，最新文章列表，使用list 存储，<code>ltrim</code>取出热点数据，删除老数据。</p><p>h) 社交类需求<br>Set 可以实现交集，从而实现共同好友等功能，Set通过求差集，可以进行好友推荐，文章推荐。</p><p>i) 排行榜<br>sorted_set可以实现有序性操作，从而实现排行榜等功能。</p><p>j) 延迟队列<br>使用sorted_set，使用 【当前时间戳 + 需要延迟的时长】做score, 消息内容作为元素,调用<code>zadd</code>来生产消息，消费者使用<code>zrangbyscore</code>获取当前时间之前的数据做轮询处理。消费完再删除任务 rem  key  member</p><p><code>Redis</code> 的key 都是字符串（<code>SDS</code>， simple dynamic string）类型，命令由客户端发送给服务端都会转换为字节流的形式，虽然看起来可能是数字、浮点数、或者字符串多种类型</p><pre class=" language-java"><code class="language-java"><span class="token operator">></span> set <span class="token number">1</span> a <span class="token comment" spellcheck="true">// 数字key</span><span class="token operator">></span> get <span class="token number">1</span><span class="token operator">></span> set <span class="token number">0.5</span> b <span class="token comment" spellcheck="true">// 浮点key</span><span class="token operator">></span> get <span class="token number">0.5</span><span class="token operator">></span> set a c <span class="token comment" spellcheck="true">// 字符串key</span><span class="token operator">></span> get a以上key 发送到服务端最终都是以字节流的形式</code></pre><p><code>SDS</code> 的特点：</p><p>a）二进制安全的数据结构，安全体现在不会丢数据（<code>c：char data[]="g\0ao"</code>，C 语言以<code>"\0"</code> 作为字符串结尾标记，业务数据存在<code>"\0"</code>时存在安全问题）</p><p>b）内存预分配机制，防止频繁扩容产生的内存分配问题</p><p>c）兼容C语言的函数库</p><p>扩容示例：</p><pre class=" language-java"><code class="language-java">redis<span class="token operator">:</span>  sds<span class="token operator">:</span>    free<span class="token operator">:</span> <span class="token number">0</span>    len<span class="token operator">:</span> <span class="token number">3</span>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">"gao"</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token string">"gao123"</span>        len<span class="token operator">:</span> <span class="token number">3</span>    addlen<span class="token operator">:</span> <span class="token function">3</span>    <span class="token punctuation">(</span>len <span class="token operator">+</span> addlen<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">=</span> <span class="token number">12</span>  <span class="token comment" spellcheck="true">//扩容，(现有长度+需要增加长度)*2</span>    <span class="token comment" spellcheck="true">// 成倍扩容，当长度len=1024，再扩容每次增加1M，(所以使用 setbit 设置大点的空间，防止频繁扩容)</span>      append，setbit     sds<span class="token operator">:</span>      free<span class="token operator">:</span> <span class="token number">6</span>      len<span class="token operator">:</span> <span class="token number">6</span>      <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">"gao123"</span>  </code></pre><p>设计思想：</p><pre class=" language-java"><code class="language-java">K<span class="token operator">-</span>V：map <span class="token operator">-</span><span class="token operator">></span> dict，数据库：海量数据的存储<span class="token number">1</span>、数组：<span class="token function">O</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> 随机访问，下表<span class="token number">2</span>、链表：<span class="token function">O</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> 头结点，遍历<span class="token number">3</span>、数：<span class="token function">log</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> 优化的比较好的场景，二分查找    <span class="token function">hash</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> 任意数据进行随机散列，并且把hash 值转换为一个自然数<span class="token punctuation">[</span>大<span class="token punctuation">]</span>创建一个大的数组：arr<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token function">hash</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> 自然数<span class="token punctuation">[</span>大<span class="token punctuation">]</span> <span class="token operator">%</span> <span class="token number">4</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> arr<span class="token punctuation">.</span>size<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> redis 就是这么干的<span class="token number">1</span>、任意相同的输入，一定能得到相同的输出<span class="token number">2</span>、不同的输入，可能得到相同的输出把现实中无限的数据放到有限的集合中，肯定会产生hash 冲突    <span class="token punctuation">(</span>k1<span class="token punctuation">,</span>v1<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>k2<span class="token punctuation">,</span>v2<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>k3<span class="token punctuation">,</span>v3<span class="token punctuation">)</span>    <span class="token function">hash</span><span class="token punctuation">(</span>k1<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">4</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token function">hash</span><span class="token punctuation">(</span>k2<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">4</span> <span class="token operator">=</span> <span class="token number">1</span>    arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">(</span>k1<span class="token punctuation">,</span>v1<span class="token punctuation">,</span>next<span class="token operator">-</span><span class="token operator">></span>null<span class="token punctuation">)</span>arr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">(</span>k3<span class="token punctuation">,</span>v3<span class="token punctuation">,</span>next<span class="token operator">-</span><span class="token operator">></span>k2<span class="token punctuation">)</span><span class="token punctuation">(</span>k2<span class="token punctuation">,</span>v2<span class="token punctuation">,</span>next<span class="token operator">-</span><span class="token operator">></span>null<span class="token punctuation">)</span>产生hash 冲突时，redis 使用的是头插法redis 是比较基础的语言，没有那么多高级特性，没有那么多工具可以用，是redis 作者自己实现的通过链表法来解决碰撞，java 中的hashMap 要复杂得多key：stringvalue：string，hash，list，set，sorted set</code></pre><p><a href="https://www.processon.com/view/link/628e1fdd0791291ba20185c4">Redis之String 类型数据结构直通车</a></p><p><code>Redis6.0</code> 多线程，但是最终执行用户请求是在单线程中进行的，渐进式扩容很有必要</p><p>有趣命令：</p><pre class=" language-java"><code class="language-java"><span class="token operator">></span> type <span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token comment" spellcheck="true">//查看key的类型</span>string<span class="token operator">></span> object encoding <span class="token number">100</span> <span class="token comment" spellcheck="true">//key 所对应的值，在redis 底层是一个什么样的编码格式</span><span class="token string">"int"</span><span class="token operator">></span> object encoding str<span class="token string">"embstr"</span><span class="token operator">></span> object encoding <span class="token number">0.1</span><span class="token string">"int"</span>    <span class="token keyword">int</span> <span class="token operator">/</span> embstr 都是redis 对内存方面的优化</code></pre><p><code>Redis</code>求模小优化：</p><pre class=" language-java"><code class="language-java">任意数 <span class="token operator">%</span> <span class="token number">2</span><span class="token operator">^</span>n <span class="token comment" spellcheck="true">//对CPU 不友好，累除法</span>任意数 <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">^</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//一次位运算</span></code></pre><p><code>Redis</code> 对于值是string 类型的底层编码结构分析：</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//type [key]，查看key 的类型</span><span class="token comment" spellcheck="true">//object encoding [key]，查值在底层的编码格式</span><span class="token comment" spellcheck="true">//redis 中所有对象的封装</span>typedef struct redisObject <span class="token punctuation">{</span><span class="token operator">&amp;</span>nbsp<span class="token punctuation">;</span><span class="token operator">&amp;</span>nbsp<span class="token punctuation">;</span><span class="token operator">&amp;</span>nbsp<span class="token punctuation">;</span><span class="token operator">&amp;</span>nbsp<span class="token punctuation">;</span>  unsigned type<span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//约束客户端命令，当前类型。位域的语法，占4个bit 位</span>  unsigned encoding<span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//编码格式，同样占4个bit 位</span>  unsigned lru<span class="token operator">:</span>LRU_BITS<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//24个bit 位，也就是3 个字节</span>  <span class="token keyword">int</span> refcount<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//引用计数法，4个字节</span>  <span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//数据真正存放的位置，8个字节</span><span class="token punctuation">}</span> robj<span class="token punctuation">;</span>redisObject 占<span class="token number">16</span>个字节的空间cache line：<span class="token number">64</span>字节，<span class="token number">64</span> <span class="token operator">-</span> <span class="token number">16</span> <span class="token operator">=</span> <span class="token number">48</span> 字节，肯定可以利用起来<span class="token number">48</span>个字节使用sdshdr8的数据结构存储，因为<span class="token number">48</span>在数据范围 <span class="token number">2</span><span class="token operator">^</span><span class="token number">5</span><span class="token operator">&amp;</span>nbsp<span class="token punctuation">;</span><span class="token operator">~</span> <span class="token number">2</span><span class="token operator">^</span><span class="token number">8</span><span class="token operator">-</span><span class="token number">1</span> 之间struct <span class="token function">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>__packed__<span class="token punctuation">)</span><span class="token punctuation">)</span> sdshdr8 <span class="token punctuation">{</span><span class="token operator">&amp;</span>nbsp<span class="token punctuation">;</span><span class="token operator">&amp;</span>nbsp<span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 表示&amp;nbsp;2^5&amp;nbsp;~ 2^8-1 的数据&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;</span>    uint8_t len<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* used */</span><span class="token operator">&amp;</span>nbsp<span class="token punctuation">;</span><span class="token operator">&amp;</span>nbsp<span class="token punctuation">;</span><span class="token operator">&amp;</span>nbsp<span class="token punctuation">;</span><span class="token operator">&amp;</span>nbsp<span class="token punctuation">;</span>    uint8_t alloc<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* excluding the header and null terminator */</span><span class="token operator">&amp;</span>nbsp<span class="token punctuation">;</span><span class="token operator">&amp;</span>nbsp<span class="token punctuation">;</span><span class="token operator">&amp;</span>nbsp<span class="token punctuation">;</span><span class="token operator">&amp;</span>nbsp<span class="token punctuation">;</span>    unsigned <span class="token keyword">char</span> flags<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* 3 lsb of type, 5 unused bits */</span><span class="token operator">&amp;</span>nbsp<span class="token punctuation">;</span><span class="token operator">&amp;</span>nbsp<span class="token punctuation">;</span><span class="token operator">&amp;</span>nbsp<span class="token punctuation">;</span><span class="token operator">&amp;</span>nbsp<span class="token punctuation">;</span>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>sds本身消耗<span class="token number">4</span>个字节，其中len、alloc、flags各占一个字节，另外<span class="token string">'\0'</span>占一个字节，因为兼容C语言的函数库最终：<span class="token number">48</span> <span class="token operator">-</span> <span class="token number">4</span> <span class="token operator">=</span> <span class="token number">44</span> 字节，用来存放实际的数据</code></pre><p>对于string 类型的value 有结论如下：</p><pre class=" language-java"><code class="language-java">value 值是string 类型的底层编码结构：<span class="token number">1</span>、value值的长度小于等于<span class="token number">20</span>，尝试转换成数字转换成功，底层使用<span class="token keyword">int</span> 编码格式<span class="token number">2</span>、value值不满足条件<span class="token number">1</span>，且长度小于等于44redis 底层使用embstr 编码结构<span class="token number">3</span>、value值不满足<span class="token number">1</span>和<span class="token number">2</span>条件，使用row 编码结构也就是sds 的数据结构，简单动态字符串</code></pre><p>扩展分析：</p><pre class=" language-java"><code class="language-java">亿级日活的统计：bit 的特点，除了<span class="token number">0</span> 就是<span class="token number">1</span>，所以可以用<span class="token number">1</span>个bit 位表示登陆状态像这样<span class="token number">1</span>个字节就可以表示<span class="token number">8</span>个用户       <span class="token number">1</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">1</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">1</span>   <span class="token operator">--</span> 登陆状态offset<span class="token operator">:</span><span class="token number">0</span> <span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span> <span class="token number">4</span> <span class="token number">5</span> <span class="token number">6</span> <span class="token number">7</span> <span class="token number">8</span> <span class="token number">9</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>命令：setbit key offset <span class="token number">0</span><span class="token operator">|</span><span class="token number">1</span>   日期可以作为一个key 使用，“<span class="token number">2022</span><span class="token operator">-</span><span class="token number">5</span><span class="token operator">-</span><span class="token number">26</span>”变种：userId 是数字时，可以作为偏移量使用setbit a<span class="token operator">-</span>bit<span class="token operator">-</span>map userId <span class="token number">1</span>setbit a<span class="token operator">-</span>bit<span class="token operator">-</span>map userId <span class="token number">1</span>getbit a<span class="token operator">-</span>bit<span class="token operator">-</span>map <span class="token number">8</span>userId<span class="token operator">:</span>bit<span class="token operator">:</span> <span class="token number">0</span><span class="token operator">/</span><span class="token function">1</span> <span class="token punctuation">(</span>默认值是<span class="token number">0</span><span class="token punctuation">)</span></code></pre><p>简单测试：</p><pre class=" language-java"><code class="language-java"><span class="token operator">></span> setbit login_05_26 <span class="token number">100</span> <span class="token number">1</span><span class="token operator">></span> setbit login_05_26 <span class="token number">100</span> <span class="token number">1</span><span class="token operator">></span> setbit login_05_26 <span class="token number">100</span> <span class="token number">1</span><span class="token operator">></span> getbit login_05_26 <span class="token number">100</span>  <span class="token comment" spellcheck="true">//获取日期5月26日用户100的活跃状态，id特别大可以减固定值优化</span><span class="token operator">></span> setbit login_05_26 <span class="token number">100</span> <span class="token number">0</span> <span class="token comment" spellcheck="true">//恢复状态</span><span class="token operator">></span> getbit login_05_26 <span class="token number">100</span><span class="token operator">></span> STRLEN login_05_26 <span class="token comment" spellcheck="true">//长度13 字节。100/8bit = 12.5 所以分配13个字节</span><span class="token operator">></span> type login_05_26 <span class="token comment" spellcheck="true">//string 类型的数据</span><span class="token operator">></span> get login_05_26 <span class="token comment" spellcheck="true">//可以执行命令，获取的数据是内存中的存储，没有实际意义</span><span class="token operator">></span> setbit login_05_26 <span class="token number">100</span> <span class="token number">1</span><span class="token operator">></span> setbit login_05_26 <span class="token number">101</span> <span class="token number">1</span><span class="token operator">></span> setbit login_05_26 <span class="token number">102</span> <span class="token number">1</span><span class="token operator">></span> setbit login_05_26 <span class="token number">103</span> <span class="token number">1</span><span class="token operator">></span> BITCOUNT login_05_26 <span class="token comment" spellcheck="true">//统计bit位是1的个数：4</span><span class="token operator">></span> strlen login_05_26 <span class="token comment" spellcheck="true">//13个字节</span><span class="token operator">></span> BITCOUNT login_05_26 <span class="token number">0</span> <span class="token number">12</span> <span class="token comment" spellcheck="true">//一共13个字节，从索引0开始，所以是0和12。可以统计一部分数据根据索引</span>string 表示数据最大是512M，索引位是<span class="token number">2</span><span class="token operator">^</span><span class="token number">32</span><span class="token operator">-</span><span class="token number">1</span>。最多可表示这么多的用户</code></pre><p>另一个扩展分析：</p><pre class=" language-java"><code class="language-java">login_05_26<span class="token operator">:</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">1</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">1</span>login_05_27<span class="token operator">:</span> <span class="token number">1</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">1</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">1</span>连续登陆情况：按位与再统计<span class="token operator">></span> BITOP and login_05_26<span class="token operator">-</span><span class="token number">27</span> login_05_26 login_05_27 <span class="token comment" spellcheck="true">//按位与操作，结果存到login_05_26-27中</span><span class="token operator">></span> BITCOUNT login_05_26<span class="token operator">-</span><span class="token number">27</span> <span class="token comment" spellcheck="true">//再做一次bitcount可以得到连续登陆的结果</span>login_05_24<span class="token operator">:</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">1</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">1</span>login_05_25<span class="token operator">:</span> <span class="token number">1</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">1</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">1</span>login_05_26<span class="token operator">:</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">1</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">1</span>login_05_27<span class="token operator">:</span> <span class="token number">1</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">1</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">1</span>login_05_28<span class="token operator">:</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">1</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">1</span>login_05_29<span class="token operator">:</span> <span class="token number">1</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">1</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">1</span>login_05_30<span class="token operator">:</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">1</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">1</span>周活：按位或，有一天登陆就行<span class="token operator">></span> BITOP or login_05_26<span class="token operator">-</span><span class="token number">27</span><span class="token operator">-</span>active login_05_26 login_05_27 <span class="token comment" spellcheck="true">//两天内有一天登陆就行</span><span class="token operator">></span> BITCOUNT login_05_26<span class="token operator">-</span><span class="token number">27</span><span class="token operator">-</span>active    redis 源码有判断只能是<span class="token number">0</span>或<span class="token number">1</span>，按位与 按位或，效率非常高汉明重量 按位操作 有兴趣的同学可以了解</code></pre>]]></content>
      
      
      
        <tags>
            
            <tag> redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>YeahWorld</title>
      <link href="/posts/blog-get//"/>
      <url>/posts/blog-get//</url>
      
        <content type="html"><![CDATA[<blockquote><p>距上次写Blog 近一年，由于最近换新工作，换了工作电脑所以决定切换主题从心开始</p></blockquote><br><p>0、安装Hexo前置条件：<code>Node.js</code> 和 <code>Git</code> 安装完成</p><p>（node -v，npm -v，git –version查看是否已安装）</p><p><code>Node.js</code> 和 <code>Git</code> 没有安装的同学请自行查找安装方法，资料很多且不复杂</p><br><p>1、安装Hexo客户端命令：<code>npm install -g hexo-cli</code></p><p>问题：执行上述安装Hexo命令，窗口提示 <font color="red">idealTree:npm: sill idealTree buildDeps</font></p> <span id="more"></span> <p>解决：(产生问题的原因是，国外镜像链接失败)</p><pre class=" language-java"><code class="language-java"># 设置为国内的阿里镜像npm config set registry https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>registry<span class="token punctuation">.</span>npm<span class="token punctuation">.</span>taobao<span class="token punctuation">.</span>org# 检查阿里镜像是否设置成功npm config get registry# 镜像设置成功后展示如下https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>registry<span class="token punctuation">.</span>npm<span class="token punctuation">.</span>taobao<span class="token punctuation">.</span>org<span class="token operator">/</span></code></pre><p>切换镜像后，重新执行安装客户端命令，执行成功！</p><br><p>2、Hexo安装完成后执行如下命令，Hexo会在<code>&lt;folder&gt;</code>文件夹下创建所需文件：</p><pre class=" language-java"><code class="language-java">$ hexo init <span class="token operator">&lt;</span>folder<span class="token operator">></span>$ cd <span class="token operator">&lt;</span>folder<span class="token operator">></span>$ npm install</code></pre><p>进入到 Hexo 安装路径，执行 <code>hexo s</code>命令，启动成功后按照提示访问<code>http://localhost:4000/</code> </p><br><p>3、Hexo常用命令（这里直接拷贝<code>helloworld</code> 中的快速开始）</p><p><strong>Create a new post</strong></p><pre class=" language-bash"><code class="language-bash">$ hexo new <span class="token string">"My New Post"</span></code></pre><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><p><strong>Run server</strong></p><pre class=" language-bash"><code class="language-bash">$ hexo server</code></pre><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><p><strong>Generate static files</strong></p><pre class=" language-bash"><code class="language-bash">$ hexo generate</code></pre><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><p><strong>Deploy to remote sites</strong></p><pre class=" language-bash"><code class="language-bash">$ hexo deploy</code></pre><p>More info:  <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p><br><p>4、Hexo安装完成，首先想到的就是主题。之前使用的是<a href="https://butterfly.js.org/">butterfly</a>主题，尝试过不少美化和特效，现在换成<a href="https://github.com/iissnan/hexo-theme-next/">next</a>主题看起来更加精简，可惜了之前的全局自动播放音乐插件（花了不少时间做好的，心碎~）</p><br><p>5、主题有了，添加背景音乐（情有独钟，因为小时候觉得QQ空间的背景音乐很酷）</p><p>这里笔者使用的是<font color="red">网易云插件的外链</font>来做背景音乐，全局音乐没得问题，可惜进入Blog没有自动播放</p><p>网易云外链获取方式：登录网易云进入目标歌单（或单曲），点击分享 链接使用浏览器打开，生成外链即可</p><p>参考文章：<a href="https://blog.csdn.net/qq_39720594/article/details/105401774">Hexo + Next 主题实现全局播放背景音乐</a></p><p>文中推荐的<font color="red">使用Aplayer + MetingJS插件</font>笔者多次尝试扔没有成功（许是遗漏操作）</p><br><p>6、使用 live2 在页面右下 添加萌娘，简单有趣</p><p>a) 准备工作，执行下面命令</p><pre class=" language-java"><code class="language-java"># 安装 live2 插件npm install <span class="token operator">--</span>save hexo<span class="token operator">-</span>helper<span class="token operator">-</span>live2d# 安装人物模型 https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>xiazeyu<span class="token operator">/</span>live2d<span class="token operator">-</span>widget<span class="token operator">-</span>modelsnpm install live2d<span class="token operator">-</span>widget<span class="token operator">-</span>model<span class="token operator">-</span>koharu</code></pre><p>b) hexo 安装目录<code>_config.yml</code>配置文件添加如下：</p><pre class=" language-java"><code class="language-java">live2d<span class="token operator">:</span>  enable<span class="token operator">:</span> <span class="token boolean">true</span>  scriptFrom<span class="token operator">:</span> local  model<span class="token operator">:</span>     use<span class="token operator">:</span> live2d<span class="token operator">-</span>widget<span class="token operator">-</span>model<span class="token operator">-</span>koharu #模型选择  display<span class="token operator">:</span>     position<span class="token operator">:</span> right  #模型位置    width<span class="token operator">:</span> <span class="token number">150</span>       #模型宽度    height<span class="token operator">:</span> <span class="token number">300</span>      #模型高度  mobile<span class="token operator">:</span>     show<span class="token operator">:</span> <span class="token boolean">false</span>      #是否在手机端显示</code></pre><p>c) 重启验证是否生效：<code>hexo clean &amp;&amp; hexo g &amp;&amp; hexo s</code></p><br><p>7、参考文章：<a href="https://jlj98.top/hexo-instructions/">Hexo搭建博客</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> 扬帆起航 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
